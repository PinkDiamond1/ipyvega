{"version":3,"sources":["webpack://jupyter-vega/./src/widget.ts","webpack://jupyter-vega/external \"@jupyter-widgets/base\"","webpack://jupyter-vega/external \"nbextensions/jupyter-vega/index\"","webpack://jupyter-vega/webpack/bootstrap","webpack://jupyter-vega/webpack/startup"],"names":["VegaWidget","DOMWidgetView","viewElement","document","createElement","errorElement","this","el","appendChild","style","color","reembed","result","finalize","undefined","spec","JSON","parse","model","get","opt","vegaEmbed","loader","http","credentials","then","res","send","type","catch","err","console","error","applyUpdate","update","Error","filter","Function","remove","newValues","insert","changeSet","view","changeset","change","key","runAsync","applyUpdates","message","updates","on","ev","checkWidgetUpdate","textContent","module","exports","__WEBPACK_EXTERNAL_MODULE__612__","__WEBPACK_EXTERNAL_MODULE__563__","__webpack_module_cache__","__webpack_require__","moduleId","__webpack_modules__","call"],"mappings":"8fAAA,eACA,SAwBA,MAAaA,UAAmB,EAAAC,cAAhC,c,oBAEE,KAAAC,YAAcC,SAASC,cAAc,OACrC,KAAAC,aAAeF,SAASC,cAAc,OAEtC,SACEE,KAAKC,GAAGC,YAAYF,KAAKJ,aACzBI,KAAKD,aAAaI,MAAMC,MAAQ,MAChCJ,KAAKC,GAAGC,YAAYF,KAAKD,cAEzB,MAAMM,EAAU,KACVL,KAAKM,SACPN,KAAKM,OAAOC,WACZP,KAAKM,YAASE,GAEhB,MAAMC,EAAOC,KAAKC,MAAMX,KAAKY,MAAMC,IAAI,iBACjCC,EAAMJ,KAAKC,MAAMX,KAAKY,MAAMC,IAAI,gBAE1B,MAARJ,GAIJ,EAAAM,UAAUf,KAAKJ,YAAaa,EAAM,OAAF,QAC9BO,OAAQ,CAAEC,KAAM,CAAEC,YAAa,iBAC5BJ,IAEFK,MAAMC,IACLpB,KAAKM,OAASc,EACdpB,KAAKqB,KAAK,CAAEC,KAAM,eAEnBC,OAAOC,GAAeC,QAAQC,MAAMF,MAGnCG,EAAqBC,GAAyB,EAAD,gCACjD,MAAMtB,EAASN,KAAKM,OACpB,GAAc,MAAVA,EACF,MAAM,IAAIuB,MAAM,8CAGlB,MAAMC,EAAS,IAAIC,SACjB,QACA,YAAcH,EAAOI,QAAU,SAAW,KAEtCC,EAAYL,EAAOM,QAAU,GAC7BC,EAAY7B,EAAO8B,KACtBC,YACAH,OAAOD,GACPD,OAAOF,SAEJxB,EAAO8B,KAAKE,OAAOV,EAAOW,IAAKJ,GAAWK,cAG5CC,EAAsBC,GAAiC,EAAD,gCAC1D,IAAK,MAAMd,KAAUc,EAAQC,cACrBhB,EAAYC,MAItB5B,KAAKY,MAAMgC,GAAG,sBAAuBvC,GACrCL,KAAKY,MAAMgC,GAAG,qBAAsBvC,GACpCL,KAAKY,MAAMgC,GAAG,cAAeC,IAC3B,MAAMH,EAtEZ,SAA2BG,GACzB,MAAe,UAAXA,EAAGvB,KACE,KAIFuB,EAgEaC,CAAkBD,GACnB,MAAXH,GAIJD,EAAaC,GAASnB,OAAOC,IAC3BxB,KAAKD,aAAagD,YAAc,GAAKvB,EACrCC,QAAQC,MAAMF,SAKlBnB,KAzEJ,gB,QCzBA2C,EAAOC,QAAUC,G,QCAjBF,EAAOC,QAAUE,ICCbC,EAA2B,GCE/B,ODCA,SAASC,EAAoBC,GAE5B,GAAGF,EAAyBE,GAC3B,OAAOF,EAAyBE,GAAUL,QAG3C,IAAID,EAASI,EAAyBE,GAAY,CAGjDL,QAAS,IAOV,OAHAM,EAAoBD,GAAUE,KAAKR,EAAOC,QAASD,EAAQA,EAAOC,QAASI,GAGpEL,EAAOC,QCjBRI,CAAoB,M","file":"widget.js","sourcesContent":["import { DOMWidgetView } from \"@jupyter-widgets/base\";\nimport { vegaEmbed } from \"./index\";\nimport { Result } from \"vega-embed\";\n\ninterface WidgetUpdate {\n  key: string;\n  remove?: string;\n  insert?: any[];\n}\n\ninterface WidgetUpdateMessage {\n  type: \"update\";\n  updates: WidgetUpdate[];\n}\n\n// validate the ev object and cast it to the correct type\nfunction checkWidgetUpdate(ev: any): WidgetUpdateMessage | null {\n  if (ev.type != \"update\") {\n    return null;\n  }\n\n  // TODO: Fully validate ev and give a easy to understand error message if it is ill-formed\n  return ev as WidgetUpdateMessage;\n}\n\nexport class VegaWidget extends DOMWidgetView {\n  result?: Result;\n  viewElement = document.createElement(\"div\");\n  errorElement = document.createElement(\"div\");\n\n  render() {\n    this.el.appendChild(this.viewElement);\n    this.errorElement.style.color = \"red\";\n    this.el.appendChild(this.errorElement);\n\n    const reembed = () => {\n      if (this.result) {\n        this.result.finalize();\n        this.result = undefined;\n      }\n      const spec = JSON.parse(this.model.get(\"_spec_source\"));\n      const opt = JSON.parse(this.model.get(\"_opt_source\"));\n\n      if (spec == null) {\n        return;\n      }\n\n      vegaEmbed(this.viewElement, spec, {\n        loader: { http: { credentials: \"same-origin\" } },\n        ...opt,\n      })\n        .then((res: any) => {\n          this.result = res;\n          this.send({ type: \"display\" });\n        })\n        .catch((err: Error) => console.error(err));\n    };\n\n    const applyUpdate = async (update: WidgetUpdate) => {\n      const result = this.result;\n      if (result == null) {\n        throw new Error(\"Internal error: no view attached to widget\");\n      }\n\n      const filter = new Function(\n        \"datum\",\n        \"return (\" + (update.remove || \"false\") + \")\"\n      );\n      const newValues = update.insert || [];\n      const changeSet = result.view\n        .changeset()\n        .insert(newValues)\n        .remove(filter);\n\n      await result.view.change(update.key, changeSet).runAsync();\n    };\n\n    const applyUpdates = async (message: WidgetUpdateMessage) => {\n      for (const update of message.updates) {\n        await applyUpdate(update);\n      }\n    };\n\n    this.model.on(\"change:_spec_source\", reembed);\n    this.model.on(\"change:_opt_source\", reembed);\n    this.model.on(\"msg:custom\", (ev: any) => {\n      const message = checkWidgetUpdate(ev);\n      if (message == null) {\n        return;\n      }\n\n      applyUpdates(message).catch((err: Error) => {\n        this.errorElement.textContent = \"\" + err;\n        console.error(err);\n      });\n    });\n\n    // initial rendering\n    reembed();\n  }\n}\n","module.exports = __WEBPACK_EXTERNAL_MODULE__612__;","module.exports = __WEBPACK_EXTERNAL_MODULE__563__;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tif(__webpack_module_cache__[moduleId]) {\n\t\treturn __webpack_module_cache__[moduleId].exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// module exports must be returned from runtime so entry inlining is disabled\n// startup\n// Load entry module and return exports\nreturn __webpack_require__(891);\n"],"sourceRoot":""}